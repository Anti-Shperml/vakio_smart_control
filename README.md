# Vakio Openair

Интеграция для Homeassiant, позволяющая управлять устройством Vakio Openair.

Для корректной работы интеграции требуется выполнить следующие шаги:

1. [Установка MQTT-брокера](#broker)
   1. [Установка дополнения](#broker_download)
   2. [Настройка брокера](#broker_settings)
2. [Подключение прибора к брокеру](#connect)
3. [Установка интеграции](#setup)

Дополнительно:

- [Управление устройством в автоматизациях](#automation)
- [Полезные ресурсы](#sources)
- [Возможные ошибки и способы их решения](#errors)

---

## <a name="broker"></a> 1. Установка и настройка MQTT-брокера

Данный этап можно пропустить, если у вас уже есть брокер.

Установка брокера производится в рамках Homeassitant.

### <a name="broker_download"></a> 1. Установка дополнения

1. В Homeassistant перейдите в **Настройки** -> **Дополнения** -> **Магазин дополнений**.
2. Найдите "Mosquitto broker" и нажмите на него.
3. Нажмите кнопку "Установить".
4. После окончания установки нажмите "Запустить".
5. Переведите слайдер "Автозагрузка" в положение **ВКЛ**.

### <a name="broker_settings"></a> 2. Настройка брокера

Данный этап является необязательным.

1. В Homeassistant перейдите в **Настройки** -> **Дополнения**.
2. Найдите "Mosquitto broker" и нажмите на него.
3. Нажмите кнопку "Запустить", если не сделали это ранее.
4. <a name="broker_normal_mqtt"></a> Во вкладке "Конфигурация" можно изменить порт "Normal MQTT", если требуется.

---

## <a name="connect"></a> 2. Подключение прибора к брокеру

Ознакомьтесь с <a target="_blanc" href="https://vakio.ru/vakio-mqtt.pdf">Инструкцией по подключению приборов по MQTT</a>.

Заполните поля в разделе "Настройка MQTT" следующим образом:

1. **Имя сервера MQTT** - ip-адрес сервера Homeassistant.
2. **Порт** - порт "Normal MQTT" ([пункт 1.2.4](#broker_normal_mqtt)), по умолчанию 1883.
3. **Логин** - не заполняется.
4. **Пароль** - не заполняется.
5. **Топик** - произвольно\*.

\* _каждый прибор должен иметь уникальный топик._

**_Пример_**

```
Имя сервера MQTT: 192.168.0.10
Порт: 1883
Логин:
Пароль:
Топик: vakio_openair1
```

## <a name="setup"></a> 3. Установка интеграции

Интеграция работает с помощью [MQTT](https://www.home-assistant.io/integrations/mqtt/) от Home Assistant, предварительно нужно его установить и создать подключение к вашему брокеру.

Для установки интеграции требуется HACS - магазин сообщества Home Assistant.

Следующий алгоритм описывает случай, когда HACS уже установлен:

1. **HACS** -> **Integrations** -> **Custom repositories**: в окно ввода добавьте ссылку на данный репозиторий.
2. **HACS** -> **Integrations**: в поле ввода "Поиск" введите запрос "Vakio".
3. Найдите интеграцию с соответствующим наименованием и перейдите на её страницу.
4. Нажмите на кнопку "Установить".
5. В появившемся окне всего одно поле - топик, который был введён в пункте [2. Подключение прибора к брокеру](#connect) (по умолчанию - `vakio`)

---

## <a name="automation"></a> Управление устройством в автоматизациях

Далее описан способ управления устройством через интерфейс автоматизаций HASS:

- Управление заслонкой и режимом работы:

  1. В разделе "Действия" на экране "Новая автоматизация" нажмите кнопку **Добавить действие** -> **Вызвать службу**;
  2. **Служба**: Выберите службу `fan.set_preset_mode`;
  3. **Цели**: Выберите объект `fan.openair`;
  4. **Preset mode**: Введите имя положения или режима работы из следующего списка:
     1. `Gate 1` - перевод заслонки в положение 1;
     2. `Gate 2` - перевод заслонки в положение 2;
     3. `Gate 3` - перевод заслонки в положение 3;
     4. `Gate 4` - перевод заслонки в положение 4;
     5. `Super Auto` - включение Smart режима.

  **_Пример YAML_**

  ```yaml
  service: fan.set_preset_mode
  data:
    preset_mode: Gate 4
  target:
    entity_id: fan.openair
  ```

- Управление скоростью вентилятора:

  1. В разделе "Действия" на экране "Новая автоматизация" нажмите кнопку **Добавить действие** -> **Вызвать службу**;
  2. **Служба**: Выберите службу `fan.set_percentage`;
  3. **Цели**: Выберите объект `fan.openair`;
  4. **Percentage**: Выберите значение скорости вентилятора кратное 20.

  **_Пример YAML_**

  ```yaml
  service: fan.set_percentage
  data:
    percentage: 80
  target:
    entity_id: fan.openair
  ```

- Управление состоянием устройства:

  1. В разделе "Действия" на экране "Новая автоматизация" нажмите кнопку **Добавить действие** -> **Вызвать службу**;
  2. **Служба**: Для включение выберите службу `fan.turn_on`, для выключения - `fan.turn_off`;

  **_Пример YAML_**

  ```yaml
  service: fan.turn_off
  data: {}
  ```

## <a name="sources"></a> Полезные ресурсы

- Интеграции HomeAssistant

  - [Atmosphere](https://github.com/maxmostovoy/vakio_atmosphere)
  - [Base Smart](https://github.com/maxmostovoy/vakio_base_smart)
  - [KIV](https://github.com/maxmostovoy/vakio_kiv)
  - [Openair](https://github.com/maxmostovoy/vakio_openair)

- Модули Majordomo

  - [Все устройства](https://github.com/maxmostovoy/vakio_smart_control)

- Sprut.hub

  - [BaseSmart + Wirenboard](https://comf.life/kak-dobavit-rekuperator-vakio-v-umnyj-dom-wirenboard-yandeks-alisu-apple-home-spruthub.html)

- Дополнительно
  - [Public API](https://github.com/maxmostovoy/vakio-public-api)
  - [Подключение устройства к MQTT-брокеру](https://vakio.ru/vakio-mqtt.pdf)

---

## <a name="errors"></a> Возможные ошибки

### <a name="auth_error"></a> **Не удалось авторизироваться**

- Проверьте корректность введенных данных брокера (Хост, порт, имя пользователя и пароль).
- Если всё заполнено правильно, проверьте, запущено ли дополнение:
  1. В Homeassistant перейдите в **Настройки** -> **Дополнения**.
  2. Найдите "Mosquitto broker" и нажмите на него.
  3. В нижней части должны быть доступны кнопки "Остановить" и "Перезапустить".

### <a name="auth_error"></a> **Значение сенсора "Неизвестно"**

- Перезагрузите прибор путём полного отключения из сети. Дождитесь полного включения устройства, если в течение минуты значения не появились, переходите к следующему пункту.
- Измените топик в устройстве на другой, переустановите интеграцию на новый топик.
